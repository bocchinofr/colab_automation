name: Upload intraday files to Google Drive

on:
  schedule:
    - cron: '0 6 * * 2-6'  # Martedì–Sabato
    - cron: '0 6 * * 0'    # Domenica
  workflow_dispatch:

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install rclone
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone

      - name: Configure rclone
        run: |
          mkdir -p ~/.config/rclone
          echo '${{ secrets.RCLONE_CONF }}' > ~/.config/rclone/rclone.conf

      - name: Check rclone config
        run: cat ~/.config/rclone/rclone.conf

      # =========================
      # Giorno settimana (UTC)
      # =========================
      - name: Calcola giorno settimana
        id: day
        run: echo "day=$(date -u +%w)" >> $GITHUB_OUTPUT

      # =========================
      # CHECK FILE STANDARD
      # Martedì → Sabato
      # =========================
      - name: Check intraday files STANDARD
        if: contains('2,3,4,5,6', steps.day.outputs.day)
        run: |
          DATE=$(date +'%Y-%m-%d')
          echo "Checking STANDARD files for ${DATE}"
          ls -l output/intraday/dati_intraday_1m_yfinance_${DATE}.xlsx
          ls -l output/intraday/riepilogo_intraday_${DATE}.xlsx

      # =========================
      # CHECK FILE D2
      # Mercoledì → Domenica
      # =========================
      - name: Check intraday files D2
        if: contains('0,3,4,5,6', steps.day.outputs.day)
        run: |
          DATE=$(date +'%Y-%m-%d')
          echo "Checking D2 files for ${DATE}"
          ls -l output/intraday/dati_intraday_D2_1m_yfinance_${DATE}.xlsx
          ls -l output/intraday/riepilogo_intraday_D2_${DATE}.xlsx

      # =========================
      # UPLOAD (sempre)
      # =========================
      - name: Upload to Google Drive
        run: |
          DATE=$(date +'%Y-%m-%d')
          echo "Uploading intraday files for ${DATE}..."
          rclone copy "output/intraday" "gdrive:Estrazioni finiviz yfinance/intraday" \
            --create-empty-src-dirs -v

      - name: Verify uploaded files
        run: |
          echo "Files now present in target folder:"
          rclone ls "gdrive:Estrazioni finiviz yfinance/intraday"
